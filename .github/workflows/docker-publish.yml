name: CD Docker Publish


on:
  push:
    branches: [ "main" ]       
  release:
    types: [published]         
  workflow_dispatch:           

env:

  DOCKER_IMAGE_BACKEND: ${{ secrets.DOCKER_USERNAME }}/studyspace-backend
  DOCKER_IMAGE_FRONTEND: ${{ secrets.DOCKER_USERNAME }}/studyspace-frontend
  DOCKER_IMAGE_CONFIG: ${{ secrets.DOCKER_USERNAME }}/studyspace-compose

jobs:
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}



      - name: Determine Docker Tags
        id: meta
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            # CASO RELEASE (Punto 5.2 y 5.6): Usa la versión (ej: 0.1.0) y 'latest'
            VERSION=${{ github.event.release.tag_name }}
            # Quitamos la 'v' si la pones (v0.1.0 -> 0.1.0) para ser más limpio
            VERSION=${VERSION#v}
            
            echo "TAGS_BACKEND=${{ env.DOCKER_IMAGE_BACKEND }}:${VERSION},${{ env.DOCKER_IMAGE_BACKEND }}:latest" >> $GITHUB_ENV
            echo "TAGS_FRONTEND=${{ env.DOCKER_IMAGE_FRONTEND }}:${VERSION},${{ env.DOCKER_IMAGE_FRONTEND }}:latest" >> $GITHUB_ENV
            echo "TAG_OCI=${VERSION}" >> $GITHUB_ENV
            echo "IS_RELEASE=true" >> $GITHUB_ENV
          
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            # CASO MAIN (Punto 5.1): Usa 'dev'
            echo "TAGS_BACKEND=${{ env.DOCKER_IMAGE_BACKEND }}:dev" >> $GITHUB_ENV
            echo "TAGS_FRONTEND=${{ env.DOCKER_IMAGE_FRONTEND }}:dev" >> $GITHUB_ENV
            echo "TAG_OCI=dev" >> $GITHUB_ENV
            echo "IS_RELEASE=false" >> $GITHUB_ENV
          
          else
            # CASO MANUAL (Punto 5.3): Usa rama-fecha-commit
            TIMESTAMP=$(date +%Y%m%d-%H%M)
            SHORT_SHA=$(git rev-parse --short HEAD)
            BRANCH_NAME=${GITHUB_REF#refs/heads/}
            SAFE_BRANCH=$(echo $BRANCH_NAME | tr / -)
            CUSTOM_TAG="${SAFE_BRANCH}-${TIMESTAMP}-${SHORT_SHA}"
            
            echo "TAGS_BACKEND=${{ env.DOCKER_IMAGE_BACKEND }}:${CUSTOM_TAG}" >> $GITHUB_ENV
            echo "TAGS_FRONTEND=${{ env.DOCKER_IMAGE_FRONTEND }}:${CUSTOM_TAG}" >> $GITHUB_ENV
            echo "TAG_OCI=${CUSTOM_TAG}" >> $GITHUB_ENV
            echo "IS_RELEASE=false" >> $GITHUB_ENV
          fi




      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ env.TAGS_BACKEND }}

          cache-from: type=gha
          cache-to: type=gha,mode=max



      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ env.TAGS_FRONTEND }}
          cache-from: type=gha
          cache-to: type=gha,mode=max




      - name: Prepare Docker Compose for Artifact
        run: |
          # Reemplaza 'build: ./backend' por la imagen real
          sed -i 's|build: ./backend|image: ${{ env.DOCKER_IMAGE_BACKEND }}:${{ env.TAG_OCI }}|g' docker-compose.yml
          
          # Reemplaza 'build: ./frontend' por la imagen real
          sed -i 's|build: ./frontend|image: ${{ env.DOCKER_IMAGE_FRONTEND }}:${{ env.TAG_OCI }}|g' docker-compose.yml
          
          # Muestra cómo quedó el archivo (para depurar en los logs de GitHub)
          cat docker-compose.yml





      - name: Package Docker Compose as OCI Artifact
        run: |
          # Creamos una imagen vacía que solo transporta el fichero yaml
          echo "FROM scratch" > Dockerfile.oci
          echo "COPY docker-compose.yml /docker-compose.yml" >> Dockerfile.oci
          
          # Construimos y subimos con el tag correspondiente (dev, 0.1.0, etc)
          docker build -f Dockerfile.oci -t ${{ env.DOCKER_IMAGE_CONFIG }}:${{ env.TAG_OCI }} .
          docker push ${{ env.DOCKER_IMAGE_CONFIG }}:${{ env.TAG_OCI }}
          
          # Si es una release oficial, subimos también la etiqueta 'latest' para el compose
          if [[ "${{ env.IS_RELEASE }}" == "true" ]]; then
            docker tag ${{ env.DOCKER_IMAGE_CONFIG }}:${{ env.TAG_OCI }} ${{ env.DOCKER_IMAGE_CONFIG }}:latest
            docker push ${{ env.DOCKER_IMAGE_CONFIG }}:latest
          fi