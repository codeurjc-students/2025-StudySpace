name: E2E Tests (Playwright)

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'docs/**'
      - 'images/**'
      - 'README.md'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'docs/**'
      - 'images/**'
      - 'README.md'

#timezone of madrid for all services (backend, mysql, mailhog)
env:
  TZ: Europe/Madrid


jobs:
  e2e-test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    #data-base + mailhog services
    services:
      #Mysql
      mysql-e2e:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: toor
          MYSQL_DATABASE: study_space_e2e_db 
        ports:
          - 3307:3306 
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      
      # --- MailHog ( SMTP server for test) ---
      mailhog:
        image: mailhog/mailhog
        ports:
          - 1025:1025 # SMTP (backend send)
          - 8025:8025 # API Web port(for emails)

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    # Temporal keystore for https
    - name: Generate Keystore for E2E
      run: |
        keytool -genkeypair -alias studyspace -keyalg RSA -keysize 2048 \
          -storetype PKCS12 -keystore backend/src/main/resources/keystore.p12 \
          -validity 3650 -storepass password -keypass password \
          -dname "CN=localhost, OU=StudySpace, O=URJC, L=Madrid, S=Madrid, C=ES"

    #backend
    - name: Start Backend
      working-directory: ./backend
      env:
        # DB Mysql(mysql-e2e on port 3307)
        SPRING_DATASOURCE_URL: jdbc:mysql://127.0.0.1:3307/study_space_e2e_db
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: toor
        
        # Email ( mailhog on port 1025)
        SPRING_MAIL_HOST: localhost
        SPRING_MAIL_PORT: 1025
        SPRING_MAIL_USERNAME: test
        SPRING_MAIL_PASSWORD: test
        SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH: false
        SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE: false

        #SSL (https)
        SERVER_PORT: 8443
        SERVER_SSL_ENABLED: true
        SERVER_SSL_KEY_STORE: classpath:keystore.p12
        SERVER_SSL_KEY_STORE_PASSWORD: password
        SERVER_SSL_KEY_STORE_TYPE: PKCS12
        SERVER_SSL_KEY_ALIAS: studyspace
      run: |
        nohup mvn spring-boot:run -Dspring-boot.run.profiles=test > backend.log 2>&1 &
      #nohup mvn spring-boot:run -Dspring-boot.run.profiles=test &

    # Node for frontend 
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install Frontend Dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Install Playwright Browsers
      working-directory: ./frontend
      run: npx playwright install --with-deps

    - name: Wait for MailHog to start
      run: |
        echo "Waiting for MailHog on port 8025..."
        timeout 60 bash -c 'until curl -s http://127.0.0.1:8025/api/v2/messages > /dev/null; do sleep 2; done'
        echo "MailHog is operational!"

    # Wait till backend 
    - name: Wait for Backend to start
      run: |
        echo "Waiting for the backend on port 8443..."
        timeout 120 bash -c 'until curl --insecure -s https://localhost:8443/actuator/health > /dev/null; do sleep 5; done'
        echo "Backend operational!"

    # Frontend and test 
    - name: Run Playwright Tests
      working-directory: ./frontend
      env:
        BASE_URL: https://localhost:4200
      run: |
        nohup npx ng serve --ssl --port 4200 --proxy-config proxy.conf.json &
        
        echo "Waiting for the Frontend..."
        timeout 120 bash -c 'until curl --insecure -s https://localhost:4200 > /dev/null; do sleep 5; done'
        
        npx playwright test

    - name: Print Backend Logs on Failure
      if: failure()
      working-directory: ./backend
      run: cat backend.log